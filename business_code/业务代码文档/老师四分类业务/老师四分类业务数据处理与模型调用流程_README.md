
# 数据处理与模型调用流程

本项目通过数据处理与模型调用结合，基于配置文件和输入数据，进行模型预测并输出结果。

## 1. 项目结构

- `teacher_classification.py`：主程序文件，包含数据处理、模型调用及结果输出的完整流程。
- `data/`：存储数据文件的目录（如 `.xlsx` 格式的数据文件）。
- `config/`：存储配置文件的目录（如 `config.json`）。
- `prompt/`：存储提示文件（模型调用时需要的提示语文本）。
- `output/`：模型预测结果的输出目录。

## 2. 数据调用流程

整个程序的核心逻辑从 `main` 函数开始。通过该函数读取配置文件、数据文件、以及模型提示（prompt），并调用多个模块函数，最终生成模型分析的结果并保存到 Excel 文件。流程如下：

### 2.1 命令行参数解析
- 使用 `argparse` 库解析命令行传递的四个参数：
  - `--data`: 需要分析的数据文件，格式为 `xlsx`。
  - `--config`: 模型和数据处理的配置文件，格式为 `json`。
  - `--prompt`: 文本文件，包含模型分析所需的提示语。
  - `--output`: 保存处理结果的 Excel 文件路径。

### 2.2 读取输入文件
- **Prompt**：从指定路径读取 `prompt` 文件，用于模型调用时的提示输入。
- **Config**：从指定路径读取 `config.json` 配置文件，包含模型参数和数据处理任务。
- **Data**：从 Excel 文件读取 `start_time`、`end_time`、`text`、`label` 等四个字段并将其转换为 JSON 格式，供后续的数据处理函数使用。

### 2.3 调用处理函数
- **`process_data_and_analyze`**：这是主逻辑函数，负责对数据进行处理、调用模型，并返回处理结果。该函数的详细逻辑见下文。

### 2.4 保存模型输出结果
- 模型分析的结果会被保存为 JSON 文件，文件名根据任务 `Task` 和模型名称 `model_name` 自动生成。

### 2.5 处理最终结果
- **`process_output_result`**：通过解析模型输出的结果，生成一个包含预测结果的 DataFrame，并将其保存为 Excel 文件。

## 3. 各个函数的功能点

### 3.1 `validate_input`
- **功能**：验证传入的 `params` 参数是否符合预期，主要检查：
  - `data_processor` 和 `Task` 是否存在且有效。
  - `data` 字段是否存在，且包含必要的键值，并且这些键对应的值是否是列表。
- **输出**：如果有错误，返回错误信息；否则返回 `None`。

### 3.2 `process_data_and_analyze`
- **功能**：这是程序的核心处理函数，负责数据处理和模型调用。主要分为以下几个步骤：
  1. **参数校验**：通过 `validate_input` 检查参数合法性。
  2. **数据处理**：初始化 `DialougueProcessor` 类，根据传入的任务 `Task`，处理数据。若处理成功，返回一个包含多个数据子集的列表 `output`。
  3. **模型调用**：若 `params` 中包含 `model_parameters`，则调用模型接口 `ModelAPI` 对每个处理后的对话文本进行分析，将分析结果附加到 `output` 中。
- **输出**：返回处理后的数据输出，包含模型的预测结果。

### 3.3 `extract_json_using_patterns`
- **功能**：使用一系列正则表达式模式，从文本中提取 JSON 格式的数据。依次尝试不同的正则表达式，适用于复杂的文本结构。
- **输出**：返回提取到的 JSON 数据，若无匹配项则返回空字典 `{}`。

### 3.4 `parse_test_result`
- **功能**：解析模型的输出结果，尝试直接解析 JSON，如果失败则通过 `extract_json_using_patterns` 提取嵌入在文本中的 JSON 片段。
- **输出**：返回解析后的 JSON 数据。

### 3.5 `process_output_result`
- **功能**：处理模型的输出结果，解析其中的预测结果，将其与原始数据相结合生成新的子列表。最终生成一个包含所有处理数据的 DataFrame。
- **输出**：返回最终生成的 DataFrame。

### 3.6 `main`
- **功能**：程序的入口，负责读取输入文件，调用核心处理逻辑 `process_data_and_analyze`，并保存结果为 Excel 文件。
- **输出**：无，程序执行过程中自动保存结果文件。

## 4. 灵活扩展点

### 4.1 正则表达式扩展
- `extract_json_using_patterns` 中使用了一个包含多个正则表达式的列表。你可以根据实际需求逐步扩展此列表，增加新的正则匹配模式，以应对更复杂的 JSON 提取场景。

### 4.2 数据处理任务扩展
- `DialougueProcessor` 类的初始化允许根据不同的 `Task` 字段执行不同的数据处理任务。可以根据实际业务需求在数据处理层添加更多任务类型，以适应不同的数据处理逻辑。

### 4.3 模型调用灵活性
- `ModelAPI` 类支持通过 `model_family` 和 `model_name` 调用不同的模型。如果未来需要支持更多模型，只需在配置文件中添加相关模型参数即可，无需修改代码逻辑。

## 5. 总结

本程序通过 `main` 函数协调多个模块，完成从数据读取、处理、模型调用到最终结果保存的完整流程。通过模块化设计，各个功能点彼此独立，方便未来的扩展和维护。
